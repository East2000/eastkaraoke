<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì± Karaoke Remote</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: Arial, sans-serif;
      padding: 15px;
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 15px;
      border: 2px solid #667eea;
    }

    .header {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 10px #667eea;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 2px solid #667eea;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    button {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 15px #667eea;
    }

    button:active {
      transform: scale(0.97);
    }

    .info-box {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid #ffd700;
      padding: 12px;
      border-radius: 5px;
      font-size: 13px;
      color: #ffd700;
      text-align: center;
      margin-bottom: 15px;
    }

    .user-section {
      background: rgba(102, 126, 234, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 2px solid #667eea;
    }

    .user-id {
      font-size: 18px;
      font-weight: bold;
      color: #00ff00;
      font-family: monospace;
    }

    .label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 5px;
    }

    .hidden {
      display: none;
    }

    .login-page {
      text-align: center;
    }

    .login-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 30px 0;
    }

    .login-buttons button {
      padding: 16px;
      font-size: 18px;
    }

    .admin-btn {
      background: #ff6600 !important;
    }

    .user-btn {
      background: #00d4ff !important;
    }

    .logout-btn {
      background: #ff0000;
      padding: 8px !important;
      font-size: 12px !important;
      margin-bottom: 15px !important;
    }

    #searchResults {
      max-height: 500px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 0;
      display: none;
      margin-top: 15px;
    }

    .song-item {
      background: rgba(0, 0, 0, 0.6);
      padding: 0;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
    }

    .song-item:hover {
      background: rgba(102, 126, 234, 0.2);
      border-color: #667eea;
      transform: scale(1.02);
    }

    .song-thumbnail {
      width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
    }

    .song-info {
      padding: 12px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .song-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
      color: white;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .song-channel {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 10px;
    }

    .reserve-btn {
      padding: 10px !important;
      margin-bottom: 0 !important;
      font-size: 14px;
      background: #00d4ff !important;
      font-weight: bold;
    }

    #queueList {
      background: rgba(0, 255, 200, 0.1);
      border: 2px solid #00ffcc;
      border-radius: 5px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .queue-item {
      padding: 12px;
      background: rgba(0, 255, 200, 0.2);
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 13px;
      border-left: 3px solid #00ffcc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .queue-item-title {
      flex-grow: 1;
      color: white;
    }

    .queue-item-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .queue-btn {
      padding: 6px 10px !important;
      margin: 0 !important;
      font-size: 12px !important;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .queue-btn-play {
      background: #00ff00 !important;
      color: black !important;
      font-weight: bold;
    }

    .queue-btn-delete {
      background: #ff0000 !important;
    }

    .queue-empty {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      padding: 15px;
      font-size: 13px;
    }

    .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .control-buttons button {
      margin-bottom: 0;
      padding: 12px;
      font-size: 14px;
    }

    .finish-btn {
      background: #00ff00 !important;
      color: black !important;
      font-weight: bold;
      grid-column: 1 / -1;
    }

    .user-list {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .user-item {
      background: rgba(102, 126, 234, 0.3);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 5px;
      border-left: 3px solid #00ffcc;
      font-size: 13px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #667eea;
      border-radius: 15px;
      padding: 25px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      background: #ff0000;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #cc0000;
      transform: scale(1.1);
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      .header {
        font-size: 22px;
      }
      .modal-content {
        max-width: 95vw;
        padding: 15px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">üé§ KARAOKE REMOTE</div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-page">
    <div style="font-size: 18px; margin: 30px 0; color: rgba(255,255,255,0.8);">Choose your role:</div>
    <div class="login-buttons">
      <button class="admin-btn" onclick="chooseRole('admin')">üëë ADMIN</button>
      <button class="user-btn" onclick="chooseRole('user')">üé§ SINGER</button>
    </div>
  </div>

  <!-- ADMIN LOGIN -->
  <div id="adminLoginSection" class="hidden">
    <div class="section-title">Admin Access</div>
    <input type="password" id="adminPin" placeholder="Enter Admin PIN" autocomplete="off">
    <button onclick="verifyAdminLogin()" style="background: #ff6600; margin-bottom: 15px;">üîì LOGIN</button>
    <button onclick="backToLogin()" class="logout-btn">‚Üê BACK</button>
    <div id="adminLoginMsg"></div>
  </div>

  <!-- FORCE CHANGE ADMIN PIN (first login) -->
  <div id="adminChangePinSection" class="hidden">
    <div class="section-title">Change Admin PIN</div>
    <div id="adminChangeMsg"></div>
    <div class="info-box" style="color: #ffd700; border-color: #ffd700;">For security, please change the default admin PIN.</div>
    <input type="password" id="newAdminPin" placeholder="New Admin PIN" autocomplete="off">
    <input type="password" id="confirmAdminPin" placeholder="Confirm New PIN" autocomplete="off">
    <button onclick="saveAdminNewPin()" style="background: #00ff00; color: black; margin-bottom: 15px;">Save New PIN</button>
  </div>

  <!-- USER LOGIN -->
  <div id="userLoginSection" class="hidden">
    <div class="section-title">Singer Login</div>
    <input type="text" id="userUsernameInput" placeholder="Enter Username">
    <input type="password" id="userPasswordInput" placeholder="Enter Password">
    <button onclick="verifyUserLogin()" style="background: #00d4ff; margin-bottom: 15px;">‚úì LOGIN</button>
    <button onclick="backToLogin()" class="logout-btn">‚Üê BACK</button>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="hidden">
    <button onclick="adminLogout()" class="logout-btn">üö™ LOGOUT</button>
    <div class="section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
      <button onclick="openModal('changePinModal')" style="background: #00d4ff; margin-bottom: 0;">üîê Change PIN</button>
      <button onclick="openModal('createUserModal')" style="background: #00ff00; color: black; font-weight: bold; margin-bottom: 0;">‚ûï Create Singer</button>
      <button onclick="openModal('allSingersModal')" style="background: #667eea; margin-bottom: 0;">üë• All Singers</button>
      <button onclick="openModal('queueControlModal')" style="background: #ff6600; margin-bottom: 0;">üéÆ Remote</button>
    </div>
  </div>

  <!-- MODALS -->
  <div id="changePinModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üîê Change Admin PIN <button class="modal-close" onclick="closeModal('changePinModal')">√ó</button></div>
      <input type="password" id="currentAdminPin" placeholder="Current PIN" autocomplete="off">
      <input type="password" id="adminNewPin" placeholder="New PIN" autocomplete="off">
      <input type="password" id="adminConfirmPin" placeholder="Confirm New PIN" autocomplete="off">
      <button onclick="changeAdminPin()" style="background: #00d4ff; margin-bottom: 15px; width: 100%;">Change PIN</button>
      <div id="changeAdminMsg"></div>
    </div>
  </div>

  <div id="createUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">‚ûï Create New Singer <button class="modal-close" onclick="closeModal('createUserModal')">√ó</button></div>
      <input type="text" id="newUserName" placeholder="Username">
      <input type="password" id="newUserPassword" placeholder="Password">
      <button onclick="createUser()" style="background: #00ff00; color: black; margin-bottom: 15px; font-weight: bold; width: 100%;">CREATE USER</button>
      <div id="createMsg"></div>
    </div>
  </div>

  <div id="allSingersModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üë• All Singers <button class="modal-close" onclick="closeModal('allSingersModal')">√ó</button></div>
      <div class="user-list" id="usersList"></div>
    </div>
  </div>

  <div id="queueControlModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üéÆ Remote <button class="modal-close" onclick="closeModal('queueControlModal')">√ó</button></div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button onclick="pauseSong()" style="background: #ff9900; font-size: 24px; padding: 15px;">‚è∏Ô∏è</button>
        <button onclick="playSong()" style="background: #00ff00; color: black; font-size: 24px; padding: 15px; font-weight: bold;">‚ñ∂Ô∏è</button>
      </div>
      <button onclick="clearAllQueue()" style="background: #ff0000; margin-bottom: 10px; width: 100%;">üóëÔ∏è CLEAR QUEUE</button>
      <button onclick="nextSongForce()" style="background: #ff6600; width: 100%;">‚èπÔ∏è STOP</button>
    </div>
  </div>

  <!-- SINGER DASHBOARD -->
  <div id="singerDashboard" class="hidden">
    <div class="user-section">
      <div class="label">Welcome:</div>
      <div class="user-id" id="singerName">Singer</div>
    </div>

    <div class="section">
      <div class="section-title">üîç SEARCH & RESERVE</div>
      <input type="text" id="searchBox" placeholder="Search song...">
      <button onclick="searchSongs()" style="background: #00d4ff; margin-bottom: 15px;">üîç SEARCH</button>
      <div id="searchResults"></div>
    </div>

    <div class="section">
      <div class="section-title">ÔøΩ LIST RESERVE</div>      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button onclick="stopSong()" style="background: #ff0000; font-weight: bold; padding: 12px;">‚èπÔ∏è STOP</button>
        <button id="playPauseBtn" onclick="togglePlayPause()" style="background: #00ff00; color: black; font-weight: bold; padding: 12px; font-size: 24px;">‚ñ∂Ô∏è</button>
        <button onclick="nextSong()" style="background: #ff6600; font-weight: bold; padding: 12px;">‚è≠Ô∏è NEXT</button>
      </div>
      <div id="queueList">
        <div class="queue-empty">No songs reserved</div>
      </div>
    </div>

    <button onclick="singerLogout()" class="logout-btn" style="margin-bottom: 0;">üö™ LOGOUT</button>
  </div>

</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/firebase.js"></script>

<script>
const DEFAULT_ADMIN_PIN = "1234";

// Hash a PIN using SHA-256 and return hex string
async function hashPin(pin) {
  const enc = new TextEncoder();
  const data = enc.encode(pin);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Firebase-backed admin PIN helpers (store hashed PIN at /admin/pinHash)
function getAdminPinHash() {
  return db.ref('admin/pinHash').once('value').then(snap => snap.val());
}

function setAdminPinHash(hash) {
  return db.ref('admin').update({ pinHash: hash });
}

async function ensureAdminPinInFirebase() {
  try {
    const snap = await db.ref('admin/pinHash').once('value');
    if (!snap.exists()) {
      const defaultHash = await hashPin(DEFAULT_ADMIN_PIN);
      await setAdminPinHash(defaultHash);
      console.log('Initialized admin pinHash in Firebase');
      return defaultHash;
    }
    return snap.val();
  } catch (e) {
    console.error('Error ensuring admin pin in Firebase:', e);
    return null;
  }
}

let currentRole = null;
let currentUserId = null;
let currentUserName = null;
let isPlaying = false; // Track play/pause state

// Modal functions
function openModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

// Close modals when clicking outside
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});

// WAIT FOR FIREBASE TO BE READY
function waitForFirebase(callback) {
  if (typeof db !== "undefined" && db) {
    callback();
  } else {
    setTimeout(() => waitForFirebase(callback), 100);
  }
}

// CHECK SAVED SESSION ON PAGE LOAD
window.addEventListener("load", () => {
  waitForFirebase(async () => {
    // Ensure admin PIN exists in Firebase (initialize if missing)
    await ensureAdminPinInFirebase();

    const savedRole = localStorage.getItem("karaoke_role");
    const savedUserId = localStorage.getItem("karaoke_userId");
    const savedUserName = localStorage.getItem("karaoke_userName");

    if (savedRole === "admin" && savedUserId === "admin") {
      currentRole = "admin";
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("adminDashboard").classList.remove("hidden");
      loadUsersList();
    } else if (savedRole === "user" && savedUserId && savedUserName) {
      currentRole = "user";
      currentUserId = savedUserId;
      currentUserName = savedUserName;
      document.getElementById("singerName").innerText = savedUserName.toUpperCase();
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("singerDashboard").classList.remove("hidden");
      showQueue();
    }
  });
});

// ROLE SELECTION
function chooseRole(role) {
  currentRole = role;
  document.getElementById("loginPage").classList.add("hidden");

  if (role === "admin") {
    document.getElementById("adminLoginSection").classList.remove("hidden");
  } else {
    document.getElementById("userLoginSection").classList.remove("hidden");
  }
}

// BACK TO LOGIN
function backToLogin() {
  currentRole = null;
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("adminLoginSection").classList.add("hidden");
  document.getElementById("userLoginSection").classList.add("hidden");
  document.getElementById("adminDashboard").classList.add("hidden");
  document.getElementById("singerDashboard").classList.add("hidden");
  document.getElementById("adminPin").value = "";
  document.getElementById("userUsernameInput").value = "";
  document.getElementById("userPasswordInput").value = "";
}

// ADMIN LOGIN
async function verifyAdminLogin() {
  const pin = document.getElementById("adminPin").value;
  if (!pin) {
    document.getElementById("adminLoginMsg").innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Enter PIN</div>';
    return;
  }
  try {
    const enteredHash = await hashPin(pin);
    const storedHash = await getAdminPinHash();
    const defaultHash = await hashPin(DEFAULT_ADMIN_PIN);

    if (enteredHash === storedHash) {
      currentRole = "admin";
      localStorage.setItem("karaoke_role", "admin");
      localStorage.setItem("karaoke_userId", "admin");
      document.getElementById("adminLoginSection").classList.add("hidden");

      // If the stored PIN is still the default, force admin to change it
      if (storedHash === defaultHash) {
        document.getElementById("adminChangePinSection").classList.remove("hidden");
        document.getElementById("adminChangeMsg").innerHTML = '';
      } else {
        document.getElementById("adminDashboard").classList.remove("hidden");
        waitForFirebase(() => loadUsersList());
      }
    } else {
      document.getElementById("adminLoginMsg").innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">‚ùå Wrong PIN</div>';
    }
  } catch (e) {
    console.error('verifyAdminLogin error', e);
    document.getElementById("adminLoginMsg").innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Error verifying PIN</div>';
  }
}

async function saveAdminNewPin() {
  const a = document.getElementById('newAdminPin').value.trim();
  const b = document.getElementById('confirmAdminPin').value.trim();
  const msg = document.getElementById('adminChangeMsg');
  msg.innerHTML = '';
  if (!a || a.length < 4) {
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">PIN must be at least 4 characters</div>';
    return;
  }
  if (a !== b) {
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">PINs do not match</div>';
    return;
  }
  try {
    const newHash = await hashPin(a);
    await setAdminPinHash(newHash);
    document.getElementById('adminChangePinSection').classList.add('hidden');
    document.getElementById('adminDashboard').classList.remove('hidden');
    waitForFirebase(() => loadUsersList());
  } catch (e) {
    console.error('saveAdminNewPin error', e);
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Error saving new PIN</div>';
  }
}

// Change admin PIN from admin dashboard (requires current PIN)
async function changeAdminPin() {
  const cur = document.getElementById('currentAdminPin').value.trim();
  const a = document.getElementById('adminNewPin').value.trim();
  const b = document.getElementById('adminConfirmPin').value.trim();
  const msg = document.getElementById('changeAdminMsg');
  msg.innerHTML = '';
  if (!cur || !a || !b) {
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Fill all fields</div>';
    return;
  }
  if (a.length < 4) {
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">New PIN must be at least 4 characters</div>';
    return;
  }
  if (a !== b) {
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">PINs do not match</div>';
    return;
  }
  try {
    const curHash = await hashPin(cur);
    const storedHash = await getAdminPinHash();
    if (curHash !== storedHash) {
      msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Current PIN is incorrect</div>';
      return;
    }
    const newHash = await hashPin(a);
    await setAdminPinHash(newHash);
    msg.innerHTML = '<div class="info-box" style="color: #00ff00; border-color: #00ff00;">‚úÖ PIN updated successfully</div>';
    // clear inputs
    document.getElementById('currentAdminPin').value = '';
    document.getElementById('adminNewPin').value = '';
    document.getElementById('adminConfirmPin').value = '';
  } catch (e) {
    console.error('changeAdminPin error', e);
    msg.innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">Error updating PIN</div>';
  }
}

// ADMIN LOGOUT
function adminLogout() {
  localStorage.removeItem("karaoke_role");
  localStorage.removeItem("karaoke_userId");
  localStorage.removeItem("karaoke_userName");
  backToLogin();
  document.getElementById("adminDashboard").classList.add("hidden");
}

// USER LOGIN
function verifyUserLogin() {
  const username = document.getElementById("userUsernameInput").value;
  const password = document.getElementById("userPasswordInput").value;
  
  if (!username || !password) {
    alert("Enter Username and Password");
    return;
  }

  waitForFirebase(() => {
    db.ref("users").once("value", snap => {
      const users = snap.val();
      let found = false;
      let userId = null;

      if (users) {
        Object.entries(users).forEach(([id, user]) => {
          if (user.username === username && user.password === password) {
            found = true;
            userId = id;
          }
        });
      }

      if (found) {
        currentUserId = userId;
        currentUserName = username;
        localStorage.setItem("karaoke_role", "user");
        localStorage.setItem("karaoke_userId", userId);
        localStorage.setItem("karaoke_userName", username);
        document.getElementById("singerName").innerText = username.toUpperCase();
        document.getElementById("userLoginSection").classList.add("hidden");
        document.getElementById("singerDashboard").classList.remove("hidden");
        showQueue();
      } else {
        alert("‚ùå Username or Password incorrect!");
      }
    }, error => {
      console.error("Login error:", error);
      alert("‚ùå Error: " + error.message);
    });
  });
}

// SINGER LOGOUT
function singerLogout() {
  localStorage.removeItem("karaoke_role");
  localStorage.removeItem("karaoke_userId");
  localStorage.removeItem("karaoke_userName");
  currentUserId = null;
  currentUserName = null;
  backToLogin();
  document.getElementById("singerDashboard").classList.add("hidden");
}

// SHOW NEXT SONG
function showNextSong() {
  waitForFirebase(() => {
    db.ref("currentSong").on("value", snap => {
      const song = snap.val();
      if (song && song.title) {
        document.getElementById("nextSongTitle").innerText = song.title;
      } else {
        document.getElementById("nextSongTitle").innerText = "No song playing";
      }
    }, error => {
      console.error("Next song error:", error);
    });
  });
}

// SHOW QUEUE (SINGER'S SONGS)
function showQueue() {
  if (!currentUserId) {
    console.error("No user ID set");
    return;
  }
  
  waitForFirebase(() => {
    console.log("Loading queue for user:", currentUserId);
    
    db.ref("queue").once("value", snap => {
      const queue = snap.val();
      const queueDiv = document.getElementById("queueList");
      
      console.log("Full queue from Firebase:", queue);

      if (!queue) {
        console.log("Queue is empty or null");
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
        return;
      }

      let html = "";
      let count = 1;
      let hasUserSongs = false;
      
      Object.entries(queue).forEach(([key, song]) => {
        console.log("Checking song - Key:", key, "UserId in DB:", song.userId, "Current user:", currentUserId, "Match:", song.userId === currentUserId);
        if (song.userId === currentUserId) {
          html += `
            <div class="queue-item" id="song-${key}">
              <div class="queue-item-title">${song.title}</div>
              <div class="queue-item-buttons">
                <button class="queue-btn queue-btn-play" onclick="playSongByKey('${key}', '${song.videoId}')">‚ñ∂ PLAY</button>
              </div>
            </div>
          `;
          count++;
          hasUserSongs = true;
        }
      });

      if (!hasUserSongs) {
        console.log("No songs found for this user in queue");
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
      } else {
        console.log("Found " + (count-1) + " songs, displaying");
        queueDiv.innerHTML = html;
      }
    }, error => {
      console.error("Queue read error:", error);
      document.getElementById("queueList").innerHTML = '<div class="queue-empty">Error: ' + error.message + '</div>';
    });
  });
}

// SEARCH SONGS
async function searchSongs() {
  if (!currentUserId) return;

  const query = document.getElementById("searchBox").value;
  if (!query) {
    alert("Enter song name");
    return;
  }

  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Searching...</div>';
  resultsDiv.style.display = "block";

  try {
    const API_KEY = "AIzaSyCmxxz1NoPMLGiNRNVyzhOyZQCFEHDvehs";
    const searchQuery = query + " karaoke";
    const response = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(searchQuery)}&maxResults=8&key=${API_KEY}`
    );
    const data = await response.json();

    if (!data.items || data.items.length === 0) {
      resultsDiv.innerHTML = '<div class="queue-empty">‚ùå No karaoke songs found</div>';
      return;
    }

    resultsDiv.innerHTML = "";
    data.items.forEach(item => {
      const videoId = item.id.videoId;
      const title = item.snippet.title;
      const channel = item.snippet.channelTitle;
      const thumbnail = item.snippet.thumbnails.medium.url;

      const div = document.createElement("div");
      div.className = "song-item";
      div.innerHTML = `
        <div class="song-thumbnail" style="background-image: url('${thumbnail}'); background-size: cover; background-position: center;">
          <div style="position: absolute; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; color: white; font-size: 12px;">‚ñ∂ PLAY</div>
        </div>
        <div class="song-info">
          <div class="song-title">${title}</div>
          <div class="song-channel">üì∫ ${channel}</div>
          <button class="reserve-btn" onclick="reserveSong('${videoId}', '${title.replace(/'/g, "\\'")}')" style="margin: 0;">‚ûï RESERVE</button>
        </div>
      `;
      resultsDiv.appendChild(div);
    });
  } catch (error) {
    resultsDiv.innerHTML = '<div class="queue-empty">‚ùå Search error</div>';
    console.error(error);
  }
}

// RESERVE SONG
function reserveSong(videoId, title) {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  console.log("Reserve attempt - UserId:", currentUserId, "Title:", title);
  
  waitForFirebase(() => {
    console.log("Firebase ready, pushing to queue...");
    db.ref("queue").push({
      videoId: videoId,
      title: title,
      userId: currentUserId,
      userName: currentUserName,
      timestamp: Date.now()
    }, (error) => {
      if (error) {
        alert("‚ùå Error: " + error.message);
        console.error("Reserve error:", error);
      } else {
        console.log("‚úÖ Song pushed to Firebase successfully");
        document.getElementById("searchResults").style.display = "none";
        document.getElementById("searchBox").value = "";
        alert("‚úÖ Song reserved!");
        // Give database a moment to update, then refresh the list
        setTimeout(() => {
          console.log("Refreshing queue...");
          showQueue();
        }, 800);
      }
    });
  });
}

// REMOVE SONG FROM QUEUE
function removeSongFromQueue(key) {
  // Remove from DOM immediately for instant feedback
  const element = document.getElementById("song-" + key);
  if (element) {
    element.style.transition = "opacity 0.3s ease";
    element.style.opacity = "0";
    setTimeout(() => {
      element.remove();
      // Check if queue is now empty
      const queueDiv = document.getElementById("queueList");
      if (queueDiv.children.length === 0) {
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
      }
    }, 300);
  }
  
  // Delete from Firebase in background
  waitForFirebase(() => {
    db.ref("queue/" + key).remove();
  });
}

// ===== ADMIN FUNCTIONS =====

// CREATE USER
function createUser() {
  const name = document.getElementById("newUserName").value;
  const password = document.getElementById("newUserPassword").value;
  
  if (!name || !password) {
    alert("Enter username and password");
    return;
  }

  waitForFirebase(() => {
    const userId = "U" + Date.now();
    db.ref("users/" + userId).set({
      username: name,
      password: password,
      score: 0,
      createdAt: Date.now()
    });

    document.getElementById("createMsg").innerHTML = `
      <div class="info-box" style="color: #00ff00; border-color: #00ff00;">
        ‚úÖ <strong>${name}</strong><br>
        ID: <strong style="font-family: monospace;">${userId}</strong><br>
        Password: <strong style="font-family: monospace;">${password}</strong>
        <button onclick="copyText('${userId}')" style="background: #667eea; padding: 5px 10px; font-size: 12px; margin-top: 8px; cursor: pointer; margin-right: 5px;">üìã COPY ID</button>
        <button onclick="copyText('${password}')" style="background: #667eea; padding: 5px 10px; font-size: 12px; margin-top: 8px; cursor: pointer;">üìã COPY PASS</button>
      </div>
    `;

    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPassword").value = "";
    loadUsersList();
  });
}

// LOAD USERS LIST
function loadUsersList() {
  waitForFirebase(() => {
    db.ref("users").once("value", snap => {
      const users = snap.val();
      const usersDiv = document.getElementById("usersList");

      if (!users) {
        usersDiv.innerHTML = '<div class="queue-empty">No users</div>';
        return;
      }

      let html = "";
      Object.entries(users).forEach(([id, user]) => {
        html += `
          <div class="user-item">
            <strong>${user.username}</strong><br>
            ID: <span style="font-family: monospace; color: #00ffff;">${id}</span><br>
            Password: <span style="font-family: monospace; color: #ffaa00;">${user.password}</span><br>
            <button onclick="deleteUser('${id}')" style="background: #ff0000; padding: 4px 10px; font-size: 11px; margin-top: 5px; cursor: pointer;">üóëÔ∏è DELETE</button>
          </div>
        `;
      });
      usersDiv.innerHTML = html;
    }, error => {
      console.error("Load users error:", error);
      document.getElementById("usersList").innerHTML = '<div class="queue-empty">Error loading users</div>';
    });
  });
}

// DELETE USER
function deleteUser(userId) {
  if (confirm("Delete user?")) {
    waitForFirebase(() => {
      db.ref("users/" + userId).remove();
      loadUsersList();
    });
  }
}

// CLEAR QUEUE
function clearAllQueue() {
  if (confirm("Clear all queue?")) {
    waitForFirebase(() => {
      db.ref("queue").remove();
      alert("‚úÖ Queue cleared");
    });
  }
}

// STOP SONG - Admin stops current song and plays next; User only if it's their song
function nextSongForce() {
  // For admin: stop and auto-play next
  // For user: only if it's their song
  if (currentRole === "admin") {
    // Admin flow: stop and auto-play next
    waitForFirebase(() => {
      db.ref("currentSong").once("value", snap => {
        const currentSong = snap.val();
        
        db.ref("currentSong").remove((error) => {
          if (error) {
            console.log("‚ùå Error stopping song:", error);
            return;
          }
          console.log("‚èπÔ∏è Current song stopped");
          
          if (currentSong) {
            db.ref("queue").once("value", queueSnap => {
              const queue = queueSnap.val();
              if (queue) {
                Object.entries(queue).forEach(([key, song]) => {
                  if (song.videoId === currentSong.videoId && 
                      song.title === currentSong.title &&
                      song.userId === currentSong.userId) {
                    db.ref("queue").child(key).remove();
                    console.log("üóëÔ∏è Removed played song from queue");
                  }
                });
              }
              
              setTimeout(() => {
                db.ref("queue").once("value", updatedSnap => {
                  const updatedQueue = updatedSnap.val();
                  if (updatedQueue && Object.keys(updatedQueue).length > 0) {
                    let firstKey = null;
                    let firstSong = null;
                    Object.entries(updatedQueue).forEach(([key, song]) => {
                      if (!firstKey) {
                        firstKey = key;
                        firstSong = song;
                      }
                    });
                    
                    if (firstSong) {
                      const songData = {
                        videoId: firstSong.videoId,
                        title: firstSong.title,
                        userId: firstSong.userId,
                        userName: firstSong.userName,
                        timestamp: Date.now()
                      };
                      
                      db.ref("currentSong").set(songData, (error) => {
                        if (!error) {
                          console.log("‚ñ∂Ô∏è Next song auto-playing:", firstSong.title);
                        }
                      });
                    }
                  } else {
                    console.log("üì≠ Queue is empty");
                  }
                });
              }, 200);
            });
          }
        });
      });
    });
  } else if (currentRole === "user" && currentUserId) {
    // User flow: same as admin - stop current song and auto-play next
    waitForFirebase(() => {
      db.ref("currentSong").once("value", snap => {
        const currentSong = snap.val();
        
        db.ref("currentSong").remove((error) => {
          if (error) {
            console.log("‚ùå Error stopping song:", error);
            return;
          }
          console.log("‚èπÔ∏è Current song stopped");
          
          if (currentSong) {
            db.ref("queue").once("value", queueSnap => {
              const queue = queueSnap.val();
              if (queue) {
                Object.entries(queue).forEach(([key, song]) => {
                  if (song.videoId === currentSong.videoId && 
                      song.title === currentSong.title &&
                      song.userId === currentSong.userId) {
                    db.ref("queue").child(key).remove();
                    console.log("üóëÔ∏è Removed played song from queue");
                  }
                });
              }
              
              setTimeout(() => {
                db.ref("queue").once("value", updatedSnap => {
                  const updatedQueue = updatedSnap.val();
                  if (updatedQueue && Object.keys(updatedQueue).length > 0) {
                    let firstKey = null;
                    let firstSong = null;
                    Object.entries(updatedQueue).forEach(([key, song]) => {
                      if (!firstKey) {
                        firstKey = key;
                        firstSong = song;
                      }
                    });
                    
                    if (firstSong) {
                      const songData = {
                        videoId: firstSong.videoId,
                        title: firstSong.title,
                        userId: firstSong.userId,
                        userName: firstSong.userName,
                        timestamp: Date.now()
                      };
                      
                      db.ref("currentSong").set(songData, (error) => {
                        if (!error) {
                          console.log("‚ñ∂Ô∏è Next song auto-playing:", firstSong.title);
                        }
                      });
                    }
                  } else {
                    console.log("üì≠ Queue is empty");
                  }
                });
              }, 200);
            });
          }
        });
      });
    });
  }
}

// ===== KARAOKE CONTROL FUNCTIONS =====

// STOP SONG
function stopSong() {
  isPlaying = false;
  const btn = document.getElementById("playPauseBtn");
  if (btn) {
    btn.textContent = "‚ñ∂Ô∏è PLAY";
    btn.style.background = "#00ff00";
  }
  
  waitForFirebase(() => {
    // Get current song info first to find and delete it from queue
    db.ref("currentSong").once("value", snap => {
      const currentSong = snap.val();
      
      // Clear current song
      db.ref("currentSong").remove();
      
      // If there was a song, find and remove it from queue
      if (currentSong && currentSong.userId === currentUserId) {
        db.ref("queue").once("value", queueSnap => {
          const queue = queueSnap.val();
          if (queue) {
            Object.entries(queue).forEach(([key, song]) => {
              if (song.videoId === currentSong.videoId && 
                  song.userId === currentSong.userId &&
                  song.title === currentSong.title) {
                // Remove from DOM immediately
                const element = document.getElementById("song-" + key);
                if (element) {
                  element.style.transition = "opacity 0.3s ease";
                  element.style.opacity = "0";
                  setTimeout(() => {
                    element.remove();
                    // Check if queue is now empty
                    const queueDiv = document.getElementById("queueList");
                    if (queueDiv && queueDiv.children.length === 0) {
                      queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
                    }
                  }, 300);
                }
                
                // Delete from Firebase in background
                db.ref("queue/" + key).remove();
              }
            });
          }
        });
      }
      
      alert("‚èπÔ∏è STOPPED");
    });
  });
}

// PLAY SONG
// TOGGLE PLAY/PAUSE
            db.ref("queue/" + key).remove();

// Pause button from Remote modal
function pauseSong() {
  isPlaying = false;
  pauseVideoTV();
}

// Play button from Remote modal
function playSong() {
  isPlaying = true;
  resumeVideoTV();
}

// Request pause from TV screen
function pauseVideoTV() {
  if (!currentUserId && !currentRole) {
    console.log("‚ùå Not logged in");
    return;
  }
  
  waitForFirebase(() => {
    db.ref("playerControl").set({
      action: "pause",
      timestamp: Date.now()
    }, (error) => {
      if (error) {
        console.log("‚ùå Error sending pause command:", error);
      } else {
        console.log("‚è∏Ô∏è Pause command sent to TV");
      }
    });
  });
}

// Request resume from TV screen
          // Clear current song
          db.ref("currentSong").remove((error) => {
            if (error) {
              console.log("‚ùå Error stopping song:", error);
              return;
            }
            console.log("‚èπÔ∏è Current song stopped");
        
            if (currentSong) {
              db.ref("queue").once("value", queueSnap => {
                const queue = queueSnap.val();
                if (queue) {
                  Object.entries(queue).forEach(([key, song]) => {
                    if (song.videoId === currentSong.videoId && 
                        song.title === currentSong.title &&
                        song.userId === currentSong.userId) {
                      db.ref("queue").child(key).remove();
                      console.log("üóëÔ∏è Removed played song from queue");
                    }
                  });
                }
            
                setTimeout(() => {
                  db.ref("queue").once("value", updatedSnap => {
                    const updatedQueue = updatedSnap.val();
                    if (updatedQueue && Object.keys(updatedQueue).length > 0) {
                      let firstKey = null;
                      let firstSong = null;
                      Object.entries(updatedQueue).forEach(([key, song]) => {
                        if (!firstKey) {
                          firstKey = key;
                          firstSong = song;
                        }
                      });
                  
                      if (firstSong) {
                        const songData = {
                          videoId: firstSong.videoId,
                          title: firstSong.title,
                          userId: firstSong.userId,
                          userName: firstSong.userName,
                          timestamp: Date.now()
                        };
                    
                        db.ref("currentSong").set(songData, (error) => {
                          if (!error) {
                            console.log("‚ñ∂Ô∏è Next song auto-playing:", firstSong.title);
                          }
                        });
                      }
                    } else {
                      console.log("üì≠ Queue is empty");
                    }
                  });
                }, 200);
              });
            }
          });
    console.log("‚ùå Not logged in");
      }
    });
  });
}

// PLAY SPECIFIC SONG FROM QUEUE BY KEY
function playSongByKey(songKey, videoId) {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  console.log("‚ñ∂Ô∏è PLAY button clicked on queue item - Key:", songKey, "VideoId:", videoId);
  
  waitForFirebase(() => {
    db.ref("queue").child(songKey).once("value", snap => {
      const song = snap.val();
      
      if (!song) {
        alert("‚ùå Song not found!");
        return;
      }
      
      // Set as current song with timestamp to force update
      const songData = {
        videoId: song.videoId,
        title: song.title,
        userId: song.userId,
        userName: song.userName || currentUserName,
        timestamp: Date.now()
      };
      
      console.log("üì§ Writing to currentSong (from queue):", songData);
      
      db.ref("currentSong").set(songData, error => {
        if (error) {
          console.error("‚ùå Firebase write error:", error);
          alert("‚ùå Error: " + error);
        } else {
          console.log("‚úÖ Successfully wrote to Firebase!");
          alert("‚ñ∂Ô∏è NOW PLAYING: " + song.title);
        }
      });
    });
  });
}

// NEXT SONG
function nextSong() {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  waitForFirebase(() => {
    // First, get current song to remove it
    db.ref("currentSong").once("value", currentSnap => {
      const currentSong = currentSnap.val();
      
      // Then get queue to find next song
      db.ref("queue").once("value", queueSnap => {
        const queue = queueSnap.val();
        if (!queue) {
          alert("‚ùå Queue is empty!");
          return;
        }
        
        // Remove current song from queue if it matches
        if (currentSong && currentSong.userId === currentUserId) {
          Object.entries(queue).forEach(([key, song]) => {
            if (song.videoId === currentSong.videoId && 
                song.userId === currentSong.userId &&
                song.title === currentSong.title) {
              db.ref("queue/" + key).remove();
            }
          });
          
          // Refresh queue after deletion
          setTimeout(() => {
            db.ref("queue").once("value", updatedSnap => {
              const updatedQueue = updatedSnap.val();
              if (updatedQueue) {
                let nextSong = null;
                Object.entries(updatedQueue).forEach(([key, song]) => {
                  if (song.userId === currentUserId && !nextSong) {
                    nextSong = song;
                  }
                });
                
                if (nextSong) {
                  db.ref("currentSong").set({
                    videoId: nextSong.videoId,
                    title: nextSong.title,
                    userId: currentUserId,
                    userName: currentUserName,
                    timestamp: Date.now()
                  });
                  alert("‚è≠Ô∏è NEXT: " + nextSong.title);
                } else {
                  alert("‚ùå No more songs in queue!");
                }
              } else {
                alert("‚ùå Queue is now empty!");
              }
            });
          }, 200);
        } else {
          // No current song, just get first one
          let firstSong = null;
          Object.entries(queue).forEach(([key, song]) => {
            if (song.userId === currentUserId && !firstSong) {
              firstSong = song;
            }
          });
          
          if (firstSong) {
            db.ref("currentSong").set({
              videoId: firstSong.videoId,
              title: firstSong.title,
              userId: currentUserId,
              userName: currentUserName,
              timestamp: Date.now()
            });
            alert("‚ñ∂Ô∏è NOW PLAYING: " + firstSong.title);
          } else {
            alert("‚ùå No songs in your queue!");
          }
        }
      });
    });
  });
}

// TEST FIREBASE READ
function testFirebaseRead() {
  waitForFirebase(() => {
    console.log("=== FIREBASE TEST ===");
    
    // Test 1: Read users
    db.ref("users").once("value", snap => {
      console.log("Users in Firebase:", snap.val());
    });
    
    // Test 2: Read entire queue
    db.ref("queue").once("value", snap => {
      console.log("Entire queue in Firebase:", snap.val());
    });
    
    // Test 3: Try to write a test record
    db.ref("queue").push({
      test: true,
      timestamp: Date.now()
    }, (error) => {
      if (error) {
        console.error("Write test failed:", error);
      } else {
        console.log("Write test successful");
        // Read it back immediately
        setTimeout(() => {
          db.ref("queue").once("value", snap => {
            console.log("Queue after test write:", snap.val());
          });
        }, 500);
      }
    });
  });
}

// Call this in console: testFirebaseRead()
</script>

</body>
</html>
