<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì± Karaoke Remote</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: Arial, sans-serif;
      padding: 15px;
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 15px;
      border: 2px solid #667eea;
    }

    .header {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 10px #667eea;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 2px solid #667eea;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    button {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 15px #667eea;
    }

    button:active {
      transform: scale(0.97);
    }

    .info-box {
      background: rgba(255, 215, 0, 0.1);
      border: 2px solid #ffd700;
      padding: 12px;
      border-radius: 5px;
      font-size: 13px;
      color: #ffd700;
      text-align: center;
      margin-bottom: 15px;
    }

    .user-section {
      background: rgba(102, 126, 234, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 2px solid #667eea;
    }

    .user-id {
      font-size: 18px;
      font-weight: bold;
      color: #00ff00;
      font-family: monospace;
    }

    .label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 5px;
    }

    .hidden {
      display: none;
    }

    .login-page {
      text-align: center;
    }

    .login-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 30px 0;
    }

    .login-buttons button {
      padding: 16px;
      font-size: 18px;
    }

    .admin-btn {
      background: #ff6600 !important;
    }

    .user-btn {
      background: #00d4ff !important;
    }

    .logout-btn {
      background: #ff0000;
      padding: 8px !important;
      font-size: 12px !important;
      margin-bottom: 15px !important;
    }

    #searchResults {
      max-height: 500px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 0;
      display: none;
      margin-top: 15px;
    }

    .song-item {
      background: rgba(0, 0, 0, 0.6);
      padding: 0;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
    }

    .song-item:hover {
      background: rgba(102, 126, 234, 0.2);
      border-color: #667eea;
      transform: scale(1.02);
    }

    .song-thumbnail {
      width: 100%;
      height: 150px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
    }

    .song-info {
      padding: 12px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .song-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
      color: white;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .song-channel {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 10px;
    }

    .reserve-btn {
      padding: 10px !important;
      margin-bottom: 0 !important;
      font-size: 14px;
      background: #00d4ff !important;
      font-weight: bold;
    }

    #queueList {
      background: rgba(0, 255, 200, 0.1);
      border: 2px solid #00ffcc;
      border-radius: 5px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .queue-item {
      padding: 12px;
      background: rgba(0, 255, 200, 0.2);
      margin-bottom: 8px;
      border-radius: 5px;
      font-size: 13px;
      border-left: 3px solid #00ffcc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .queue-item-title {
      flex-grow: 1;
      color: white;
    }

    .queue-item-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .queue-btn {
      padding: 6px 10px !important;
      margin: 0 !important;
      font-size: 12px !important;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .queue-btn-play {
      background: #00ff00 !important;
      color: black !important;
      font-weight: bold;
    }

    .queue-btn-delete {
      background: #ff0000 !important;
    }

    .queue-empty {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      padding: 15px;
      font-size: 13px;
    }

    .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .control-buttons button {
      margin-bottom: 0;
      padding: 12px;
      font-size: 14px;
    }

    .finish-btn {
      background: #00ff00 !important;
      color: black !important;
      font-weight: bold;
      grid-column: 1 / -1;
    }

    .user-list {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .user-item {
      background: rgba(102, 126, 234, 0.3);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 5px;
      border-left: 3px solid #00ffcc;
      font-size: 13px;
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      .header {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">üé§ KARAOKE REMOTE</div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-page">
    <div style="font-size: 18px; margin: 30px 0; color: rgba(255,255,255,0.8);">Choose your role:</div>
    <div class="login-buttons">
      <button class="admin-btn" onclick="chooseRole('admin')">üëë ADMIN</button>
      <button class="user-btn" onclick="chooseRole('user')">üé§ SINGER</button>
    </div>
  </div>

  <!-- ADMIN LOGIN -->
  <div id="adminLoginSection" class="hidden">
    <div class="section-title">Admin Access</div>
    <input type="password" id="adminPin" placeholder="Enter Admin PIN" autocomplete="off">
    <button onclick="verifyAdminLogin()" style="background: #ff6600; margin-bottom: 15px;">üîì LOGIN</button>
    <button onclick="backToLogin()" class="logout-btn">‚Üê BACK</button>
    <div id="adminLoginMsg"></div>
  </div>

  <!-- USER LOGIN -->
  <div id="userLoginSection" class="hidden">
    <div class="section-title">Singer Login</div>
    <input type="text" id="userUsernameInput" placeholder="Enter Username">
    <input type="password" id="userPasswordInput" placeholder="Enter Password">
    <button onclick="verifyUserLogin()" style="background: #00d4ff; margin-bottom: 15px;">‚úì LOGIN</button>
    <button onclick="backToLogin()" class="logout-btn">‚Üê BACK</button>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="hidden">
    <button onclick="adminLogout()" class="logout-btn">üö™ LOGOUT</button>

    <div class="section">
      <div class="section-title">‚ûï CREATE NEW SINGER</div>
      <input type="text" id="newUserName" placeholder="Username">
      <input type="password" id="newUserPassword" placeholder="Password">
      <button onclick="createUser()" style="background: #00ff00; color: black; margin-bottom: 15px; font-weight: bold;">CREATE USER</button>
      <div id="createMsg"></div>
    </div>

    <div class="section">
      <div class="section-title">üë• ALL SINGERS</div>
      <div class="user-list" id="usersList"></div>
    </div>

    <div class="section">
      <div class="section-title">üéÆ QUEUE CONTROL</div>
      <button onclick="clearAllQueue()" style="background: #ff0000; margin-bottom: 10px;">üóëÔ∏è CLEAR QUEUE</button>
      <button onclick="nextSongForce()" style="background: #ff6600;">‚è≠Ô∏è SKIP SONG</button>
    </div>
  </div>

  <!-- SINGER DASHBOARD -->
  <div id="singerDashboard" class="hidden">
    <div class="user-section">
      <div class="label">Welcome:</div>
      <div class="user-id" id="singerName">Singer</div>
    </div>

    <div class="section">
      <div class="section-title">üîç SEARCH & RESERVE</div>
      <input type="text" id="searchBox" placeholder="Search song...">
      <button onclick="searchSongs()" style="background: #00d4ff; margin-bottom: 15px;">üîç SEARCH</button>
      <div id="searchResults"></div>
    </div>

    <div class="section">
      <div class="section-title">ÔøΩ LIST RESERVE</div>      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button onclick="stopSong()" style="background: #ff0000; font-weight: bold; padding: 12px;">‚èπÔ∏è STOP</button>
        <button id="playPauseBtn" onclick="togglePlayPause()" style="background: #00ff00; color: black; font-weight: bold; padding: 12px; font-size: 24px;">‚ñ∂Ô∏è</button>
        <button onclick="nextSong()" style="background: #ff6600; font-weight: bold; padding: 12px;">‚è≠Ô∏è NEXT</button>
      </div>
      <div id="queueList">
        <div class="queue-empty">No songs reserved</div>
      </div>
    </div>

    <button onclick="singerLogout()" class="logout-btn" style="margin-bottom: 0;">üö™ LOGOUT</button>
  </div>

</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/firebase.js"></script>

<script>
const ADMIN_PIN = "1234";
let currentRole = null;
let currentUserId = null;
let currentUserName = null;
let isPlaying = false; // Track play/pause state

// WAIT FOR FIREBASE TO BE READY
function waitForFirebase(callback) {
  if (typeof db !== "undefined" && db) {
    callback();
  } else {
    setTimeout(() => waitForFirebase(callback), 100);
  }
}

// CHECK SAVED SESSION ON PAGE LOAD
window.addEventListener("load", () => {
  waitForFirebase(() => {
    const savedRole = localStorage.getItem("karaoke_role");
    const savedUserId = localStorage.getItem("karaoke_userId");
    const savedUserName = localStorage.getItem("karaoke_userName");

    if (savedRole === "admin" && savedUserId === "admin") {
      currentRole = "admin";
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("adminDashboard").classList.remove("hidden");
      loadUsersList();
    } else if (savedRole === "user" && savedUserId && savedUserName) {
      currentRole = "user";
      currentUserId = savedUserId;
      currentUserName = savedUserName;
      document.getElementById("singerName").innerText = savedUserName.toUpperCase();
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("singerDashboard").classList.remove("hidden");
      showQueue();
    }
  });
});

// ROLE SELECTION
function chooseRole(role) {
  currentRole = role;
  document.getElementById("loginPage").classList.add("hidden");

  if (role === "admin") {
    document.getElementById("adminLoginSection").classList.remove("hidden");
  } else {
    document.getElementById("userLoginSection").classList.remove("hidden");
  }
}

// BACK TO LOGIN
function backToLogin() {
  currentRole = null;
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("adminLoginSection").classList.add("hidden");
  document.getElementById("userLoginSection").classList.add("hidden");
  document.getElementById("adminDashboard").classList.add("hidden");
  document.getElementById("singerDashboard").classList.add("hidden");
  document.getElementById("adminPin").value = "";
  document.getElementById("userUsernameInput").value = "";
  document.getElementById("userPasswordInput").value = "";
}

// ADMIN LOGIN
function verifyAdminLogin() {
  const pin = document.getElementById("adminPin").value;
  if (pin === ADMIN_PIN) {
    currentRole = "admin";
    localStorage.setItem("karaoke_role", "admin");
    localStorage.setItem("karaoke_userId", "admin");
    document.getElementById("adminLoginSection").classList.add("hidden");
    document.getElementById("adminDashboard").classList.remove("hidden");
    waitForFirebase(() => loadUsersList());
  } else {
    document.getElementById("adminLoginMsg").innerHTML = '<div class="info-box" style="color: #ff0000; border-color: #ff0000;">‚ùå Wrong PIN</div>';
  }
}

// ADMIN LOGOUT
function adminLogout() {
  localStorage.removeItem("karaoke_role");
  localStorage.removeItem("karaoke_userId");
  localStorage.removeItem("karaoke_userName");
  backToLogin();
  document.getElementById("adminDashboard").classList.add("hidden");
}

// USER LOGIN
function verifyUserLogin() {
  const username = document.getElementById("userUsernameInput").value;
  const password = document.getElementById("userPasswordInput").value;
  
  if (!username || !password) {
    alert("Enter Username and Password");
    return;
  }

  waitForFirebase(() => {
    db.ref("users").once("value", snap => {
      const users = snap.val();
      let found = false;
      let userId = null;

      if (users) {
        Object.entries(users).forEach(([id, user]) => {
          if (user.username === username && user.password === password) {
            found = true;
            userId = id;
          }
        });
      }

      if (found) {
        currentUserId = userId;
        currentUserName = username;
        localStorage.setItem("karaoke_role", "user");
        localStorage.setItem("karaoke_userId", userId);
        localStorage.setItem("karaoke_userName", username);
        document.getElementById("singerName").innerText = username.toUpperCase();
        document.getElementById("userLoginSection").classList.add("hidden");
        document.getElementById("singerDashboard").classList.remove("hidden");
        showQueue();
      } else {
        alert("‚ùå Username or Password incorrect!");
      }
    }, error => {
      console.error("Login error:", error);
      alert("‚ùå Error: " + error.message);
    });
  });
}

// SINGER LOGOUT
function singerLogout() {
  localStorage.removeItem("karaoke_role");
  localStorage.removeItem("karaoke_userId");
  localStorage.removeItem("karaoke_userName");
  currentUserId = null;
  currentUserName = null;
  backToLogin();
  document.getElementById("singerDashboard").classList.add("hidden");
}

// SHOW NEXT SONG
function showNextSong() {
  waitForFirebase(() => {
    db.ref("currentSong").on("value", snap => {
      const song = snap.val();
      if (song && song.title) {
        document.getElementById("nextSongTitle").innerText = song.title;
      } else {
        document.getElementById("nextSongTitle").innerText = "No song playing";
      }
    }, error => {
      console.error("Next song error:", error);
    });
  });
}

// SHOW QUEUE (SINGER'S SONGS)
function showQueue() {
  if (!currentUserId) {
    console.error("No user ID set");
    return;
  }
  
  waitForFirebase(() => {
    console.log("Loading queue for user:", currentUserId);
    
    db.ref("queue").once("value", snap => {
      const queue = snap.val();
      const queueDiv = document.getElementById("queueList");
      
      console.log("Full queue from Firebase:", queue);

      if (!queue) {
        console.log("Queue is empty or null");
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
        return;
      }

      let html = "";
      let count = 1;
      let hasUserSongs = false;
      
      Object.entries(queue).forEach(([key, song]) => {
        console.log("Checking song - Key:", key, "UserId in DB:", song.userId, "Current user:", currentUserId, "Match:", song.userId === currentUserId);
        if (song.userId === currentUserId) {
          html += `
            <div class="queue-item" id="song-${key}">
              <div class="queue-item-title">${song.title}</div>
              <div class="queue-item-buttons">
                <button class="queue-btn queue-btn-play" onclick="alert('Playing: ${song.title}')">‚ñ∂ PLAY</button>
              </div>
            </div>
          `;
          count++;
          hasUserSongs = true;
        }
      });

      if (!hasUserSongs) {
        console.log("No songs found for this user in queue");
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
      } else {
        console.log("Found " + (count-1) + " songs, displaying");
        queueDiv.innerHTML = html;
      }
    }, error => {
      console.error("Queue read error:", error);
      document.getElementById("queueList").innerHTML = '<div class="queue-empty">Error: ' + error.message + '</div>';
    });
  });
}

// SEARCH SONGS
async function searchSongs() {
  if (!currentUserId) return;

  const query = document.getElementById("searchBox").value;
  if (!query) {
    alert("Enter song name");
    return;
  }

  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Searching...</div>';
  resultsDiv.style.display = "block";

  try {
    const API_KEY = "AIzaSyCmxxz1NoPMLGiNRNVyzhOyZQCFEHDvehs";
    const searchQuery = query + " karaoke";
    const response = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(searchQuery)}&maxResults=8&key=${API_KEY}`
    );
    const data = await response.json();

    if (!data.items || data.items.length === 0) {
      resultsDiv.innerHTML = '<div class="queue-empty">‚ùå No karaoke songs found</div>';
      return;
    }

    resultsDiv.innerHTML = "";
    data.items.forEach(item => {
      const videoId = item.id.videoId;
      const title = item.snippet.title;
      const channel = item.snippet.channelTitle;
      const thumbnail = item.snippet.thumbnails.medium.url;

      const div = document.createElement("div");
      div.className = "song-item";
      div.innerHTML = `
        <div class="song-thumbnail" style="background-image: url('${thumbnail}'); background-size: cover; background-position: center;">
          <div style="position: absolute; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; color: white; font-size: 12px;">‚ñ∂ PLAY</div>
        </div>
        <div class="song-info">
          <div class="song-title">${title}</div>
          <div class="song-channel">üì∫ ${channel}</div>
          <button class="reserve-btn" onclick="reserveSong('${videoId}', '${title.replace(/'/g, "\\'")}')" style="margin: 0;">‚ûï RESERVE</button>
        </div>
      `;
      resultsDiv.appendChild(div);
    });
  } catch (error) {
    resultsDiv.innerHTML = '<div class="queue-empty">‚ùå Search error</div>';
    console.error(error);
  }
}

// RESERVE SONG
function reserveSong(videoId, title) {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  console.log("Reserve attempt - UserId:", currentUserId, "Title:", title);
  
  waitForFirebase(() => {
    console.log("Firebase ready, pushing to queue...");
    db.ref("queue").push({
      videoId: videoId,
      title: title,
      userId: currentUserId,
      userName: currentUserName,
      timestamp: Date.now()
    }, (error) => {
      if (error) {
        alert("‚ùå Error: " + error.message);
        console.error("Reserve error:", error);
      } else {
        console.log("‚úÖ Song pushed to Firebase successfully");
        document.getElementById("searchResults").style.display = "none";
        document.getElementById("searchBox").value = "";
        alert("‚úÖ Song reserved!");
        // Give database a moment to update, then refresh the list
        setTimeout(() => {
          console.log("Refreshing queue...");
          showQueue();
        }, 800);
      }
    });
  });
}

// REMOVE SONG FROM QUEUE
function removeSongFromQueue(key) {
  // Remove from DOM immediately for instant feedback
  const element = document.getElementById("song-" + key);
  if (element) {
    element.style.transition = "opacity 0.3s ease";
    element.style.opacity = "0";
    setTimeout(() => {
      element.remove();
      // Check if queue is now empty
      const queueDiv = document.getElementById("queueList");
      if (queueDiv.children.length === 0) {
        queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
      }
    }, 300);
  }
  
  // Delete from Firebase in background
  waitForFirebase(() => {
    db.ref("queue/" + key).remove();
  });
}

// ===== ADMIN FUNCTIONS =====

// CREATE USER
function createUser() {
  const name = document.getElementById("newUserName").value;
  const password = document.getElementById("newUserPassword").value;
  
  if (!name || !password) {
    alert("Enter username and password");
    return;
  }

  waitForFirebase(() => {
    const userId = "U" + Date.now();
    db.ref("users/" + userId).set({
      username: name,
      password: password,
      score: 0,
      createdAt: Date.now()
    });

    document.getElementById("createMsg").innerHTML = `
      <div class="info-box" style="color: #00ff00; border-color: #00ff00;">
        ‚úÖ <strong>${name}</strong><br>
        ID: <strong style="font-family: monospace;">${userId}</strong><br>
        Password: <strong style="font-family: monospace;">${password}</strong>
        <button onclick="copyText('${userId}')" style="background: #667eea; padding: 5px 10px; font-size: 12px; margin-top: 8px; cursor: pointer; margin-right: 5px;">üìã COPY ID</button>
        <button onclick="copyText('${password}')" style="background: #667eea; padding: 5px 10px; font-size: 12px; margin-top: 8px; cursor: pointer;">üìã COPY PASS</button>
      </div>
    `;

    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPassword").value = "";
    loadUsersList();
  });
}

// LOAD USERS LIST
function loadUsersList() {
  waitForFirebase(() => {
    db.ref("users").once("value", snap => {
      const users = snap.val();
      const usersDiv = document.getElementById("usersList");

      if (!users) {
        usersDiv.innerHTML = '<div class="queue-empty">No users</div>';
        return;
      }

      let html = "";
      Object.entries(users).forEach(([id, user]) => {
        html += `
          <div class="user-item">
            <strong>${user.username}</strong><br>
            ID: <span style="font-family: monospace; color: #00ffff;">${id}</span><br>
            Password: <span style="font-family: monospace; color: #ffaa00;">${user.password}</span><br>
            <button onclick="deleteUser('${id}')" style="background: #ff0000; padding: 4px 10px; font-size: 11px; margin-top: 5px; cursor: pointer;">üóëÔ∏è DELETE</button>
          </div>
        `;
      });
      usersDiv.innerHTML = html;
    }, error => {
      console.error("Load users error:", error);
      document.getElementById("usersList").innerHTML = '<div class="queue-empty">Error loading users</div>';
    });
  });
}

// DELETE USER
function deleteUser(userId) {
  if (confirm("Delete user?")) {
    waitForFirebase(() => {
      db.ref("users/" + userId).remove();
      loadUsersList();
    });
  }
}

// CLEAR QUEUE
function clearAllQueue() {
  if (confirm("Clear all queue?")) {
    waitForFirebase(() => {
      db.ref("queue").remove();
      alert("‚úÖ Queue cleared");
    });
  }
}

// SKIP SONG
function nextSongForce() {
  waitForFirebase(() => {
    db.ref("currentSong").remove();
    alert("‚è≠Ô∏è Song skipped");
  });
}

// ===== KARAOKE CONTROL FUNCTIONS =====

// STOP SONG
function stopSong() {
  isPlaying = false;
  const btn = document.getElementById("playPauseBtn");
  if (btn) {
    btn.textContent = "‚ñ∂Ô∏è PLAY";
    btn.style.background = "#00ff00";
  }
  
  waitForFirebase(() => {
    // Get current song info first to find and delete it from queue
    db.ref("currentSong").once("value", snap => {
      const currentSong = snap.val();
      
      // Clear current song
      db.ref("currentSong").remove();
      
      // If there was a song, find and remove it from queue
      if (currentSong && currentSong.userId === currentUserId) {
        db.ref("queue").once("value", queueSnap => {
          const queue = queueSnap.val();
          if (queue) {
            Object.entries(queue).forEach(([key, song]) => {
              if (song.videoId === currentSong.videoId && 
                  song.userId === currentSong.userId &&
                  song.title === currentSong.title) {
                // Remove from DOM immediately
                const element = document.getElementById("song-" + key);
                if (element) {
                  element.style.transition = "opacity 0.3s ease";
                  element.style.opacity = "0";
                  setTimeout(() => {
                    element.remove();
                    // Check if queue is now empty
                    const queueDiv = document.getElementById("queueList");
                    if (queueDiv && queueDiv.children.length === 0) {
                      queueDiv.innerHTML = '<div class="queue-empty">No songs reserved</div>';
                    }
                  }, 300);
                }
                
                // Delete from Firebase in background
                db.ref("queue/" + key).remove();
              }
            });
          }
        });
      }
      
      alert("‚èπÔ∏è STOPPED");
    });
  });
}

// PLAY SONG
// TOGGLE PLAY/PAUSE
function togglePlayPause() {
  const btn = document.getElementById("playPauseBtn");
  
  if (isPlaying) {
    // Currently playing - pause the video
    isPlaying = false;
    btn.textContent = "‚ñ∂Ô∏è";
    btn.style.background = "#00ff00";
    pauseVideoTV();  // Pause video in index.html
  } else {
    // Currently paused - resume the video
    isPlaying = true;
    btn.textContent = "‚è∏Ô∏è";
    btn.style.background = "#ffaa00";
    resumeVideoTV();  // Resume video in index.html
  }
}

// Request pause from TV screen
function pauseVideoTV() {
  if (window.tvPlayer && window.tvPlayer.pauseVideo) {
    window.tvPlayer.pauseVideo();
    console.log("‚è∏Ô∏è Video paused");
  } else {
    console.log("‚ÑπÔ∏è TV player not available");
  }
}

// Request resume from TV screen
function resumeVideoTV() {
  if (window.tvPlayer && window.tvPlayer.playVideo) {
    window.tvPlayer.playVideo();
    console.log("‚ñ∂Ô∏è Video resumed");
  } else {
    console.log("‚ÑπÔ∏è TV player not available");
  }
}

// PLAY SONG
function playSong() {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  console.log("‚ñ∂Ô∏è PLAY button clicked by user:", currentUserId);
  
  waitForFirebase(() => {
    console.log("üì§ Firebase ready, fetching queue...");
    
    db.ref("queue").once("value", snap => {
      const queue = snap.val();
      console.log("üìã Queue data:", queue);
      
      if (!queue) {
        alert("‚ùå Queue is empty!");
        return;
      }
      
      // Find first song by current user
      let firstSong = null;
      let firstKey = null;
      
      Object.entries(queue).forEach(([key, song]) => {
        if (song.userId === currentUserId && !firstSong) {
          firstSong = song;
          firstKey = key;
          console.log("‚úÖ Found first song:", song.title);
        }
      });
      
      if (!firstSong) {
        alert("‚ùå No songs in your queue!");
        return;
      }
      
      // Set as current song with timestamp to force update
      const songData = {
        videoId: firstSong.videoId,
        title: firstSong.title,
        userId: currentUserId,
        userName: currentUserName,
        timestamp: Date.now()
      };
      
      console.log("üì§ Writing to currentSong:", songData);
      
      db.ref("currentSong").set(songData, error => {
        if (error) {
          console.error("‚ùå Firebase write error:", error);
          alert("‚ùå Error: " + error);
        } else {
          console.log("‚úÖ Successfully wrote to Firebase!");
          alert("‚ñ∂Ô∏è NOW PLAYING: " + firstSong.title);
        }
      });
    });
  });
}

// NEXT SONG
function nextSong() {
  if (!currentUserId) {
    alert("‚ùå Not logged in!");
    return;
  }
  
  waitForFirebase(() => {
    // First, get current song to remove it
    db.ref("currentSong").once("value", currentSnap => {
      const currentSong = currentSnap.val();
      
      // Then get queue to find next song
      db.ref("queue").once("value", queueSnap => {
        const queue = queueSnap.val();
        if (!queue) {
          alert("‚ùå Queue is empty!");
          return;
        }
        
        // Remove current song from queue if it matches
        if (currentSong && currentSong.userId === currentUserId) {
          Object.entries(queue).forEach(([key, song]) => {
            if (song.videoId === currentSong.videoId && 
                song.userId === currentSong.userId &&
                song.title === currentSong.title) {
              db.ref("queue/" + key).remove();
            }
          });
          
          // Refresh queue after deletion
          setTimeout(() => {
            db.ref("queue").once("value", updatedSnap => {
              const updatedQueue = updatedSnap.val();
              if (updatedQueue) {
                let nextSong = null;
                Object.entries(updatedQueue).forEach(([key, song]) => {
                  if (song.userId === currentUserId && !nextSong) {
                    nextSong = song;
                  }
                });
                
                if (nextSong) {
                  db.ref("currentSong").set({
                    videoId: nextSong.videoId,
                    title: nextSong.title,
                    userId: currentUserId,
                    userName: currentUserName,
                    timestamp: Date.now()
                  });
                  alert("‚è≠Ô∏è NEXT: " + nextSong.title);
                } else {
                  alert("‚ùå No more songs in queue!");
                }
              } else {
                alert("‚ùå Queue is now empty!");
              }
            });
          }, 200);
        } else {
          // No current song, just get first one
          let firstSong = null;
          Object.entries(queue).forEach(([key, song]) => {
            if (song.userId === currentUserId && !firstSong) {
              firstSong = song;
            }
          });
          
          if (firstSong) {
            db.ref("currentSong").set({
              videoId: firstSong.videoId,
              title: firstSong.title,
              userId: currentUserId,
              userName: currentUserName,
              timestamp: Date.now()
            });
            alert("‚ñ∂Ô∏è NOW PLAYING: " + firstSong.title);
          } else {
            alert("‚ùå No songs in your queue!");
          }
        }
      });
    });
  });
}

// TEST FIREBASE READ
function testFirebaseRead() {
  waitForFirebase(() => {
    console.log("=== FIREBASE TEST ===");
    
    // Test 1: Read users
    db.ref("users").once("value", snap => {
      console.log("Users in Firebase:", snap.val());
    });
    
    // Test 2: Read entire queue
    db.ref("queue").once("value", snap => {
      console.log("Entire queue in Firebase:", snap.val());
    });
    
    // Test 3: Try to write a test record
    db.ref("queue").push({
      test: true,
      timestamp: Date.now()
    }, (error) => {
      if (error) {
        console.error("Write test failed:", error);
      } else {
        console.log("Write test successful");
        // Read it back immediately
        setTimeout(() => {
          db.ref("queue").once("value", snap => {
            console.log("Queue after test write:", snap.val());
          });
        }, 500);
      }
    });
  });
}

// Call this in console: testFirebaseRead()
</script>

</body>
</html>
