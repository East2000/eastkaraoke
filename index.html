<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé§ Karaoke TV - Videoke System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      text-align: center;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
      height: 100vh;
    }

    .tv-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
    }

    .header {
      font-size: 2em;
      margin-bottom: 10px;
      font-weight: bold;
      text-shadow: 0 0 10px #00ff88;
    }

    .player-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 0;
      overflow: hidden;
      position: relative;
      min-height: 0;
      width: 100%;
    }

    #player {
      width: 100%;
      flex: 1;
      border: none;
      min-height: 0;
      display: block;
      position: relative;
    }

    .countdown-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
    }

    .countdown-overlay.show {
      display: flex;
    }

    .countdown-text {
      font-size: 120px;
      font-weight: bold;
      color: #00ffcc;
      text-shadow: 0 0 30px #00ffcc;
      animation: countdownPulse 1s ease-in-out;
    }

    @keyframes countdownPulse {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .lyrics-box {
      display: none;
    }

    .score-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      animation: scoreIn 0.5s ease-in;
    }

    .score-overlay.show {
      display: flex;
    }

    .score-content {
      text-align: center;
      color: white;
      font-size: 48px;
      font-weight: bold;
      text-shadow: 0 0 30px #ffd700;
    }

    .score-content .score-title {
      font-size: 36px;
      color: #ffd700;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    .score-content .score-value {
      font-size: 80px;
      color: #ff00ff;
      margin: 20px 0;
      text-shadow: 0 0 50px #ff00ff;
    }

    .score-content .singer-name {
      display: none;
    }

    @keyframes scoreIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
      from { opacity: 0; }
      to { opacity: 1; }
    
    .bottom-section {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
      align-items: center;
    }

    .qr-section {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #qr {
      background: white;
      padding: 10px;
      border-radius: 5px;
      width: 150px;
      height: 150px;
    }

    .score-box {
      display: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .queue-box {
      position: relative;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 0;
      width: 100%;
      border: none;
      border-bottom: 2px solid #00ffcc;
      z-index: 100;
      box-shadow: none;
      margin: 0;
      pointer-events: auto;
      min-height: auto;
      flex-shrink: 0;
    }

    .queue-box > div:first-child {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: white;
      text-transform: uppercase;
      text-align: left;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    #queueList {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      overflow-y: hidden;
      flex-wrap: nowrap;
      align-items: flex-start;
      max-width: 100%;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #queueList::-webkit-scrollbar {
      display: none;
    }

    .queue-item {
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 5px;
      font-size: 15px;
      color: #ffffff;
      border-left: 4px solid #00ffcc;
      flex: 0 0 auto;
      min-height: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      white-space: normal;
      word-wrap: break-word;
      min-width: 180px;
      font-weight: 500;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .admin-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 15px;
      background: #ff006e;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    button:hover {
      background: #ff0040;
      transform: scale(1.1);
    }

    .loading {
      font-size: 24px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* Fullscreen mode - Singer view */
    :fullscreen .header,
    :-webkit-full-screen .header {
      display: none !important;
    }

    :fullscreen .admin-controls,
    :-webkit-full-screen .admin-controls {
      display: none !important;
    }

    :fullscreen .bottom-section,
    :-webkit-full-screen .bottom-section {
      display: none !important;
    }

    :fullscreen .tv-container,
    :-webkit-full-screen .tv-container {
      padding: 0 !important;
    }

    :fullscreen .player-section,
    :-webkit-full-screen .player-section {
      margin-bottom: 0 !important;
      flex: 2 !important;
    }

    :fullscreen .lyrics-box,
    :-webkit-full-screen .lyrics-box {
      font-size: 48px !important;
      padding: 40px !important;
      flex: 0.5 !important;
      border: none !important;
      border-radius: 0 !important;
    }

    @media (max-width: 1024px) {
      .bottom-section {
        grid-template-columns: 1fr;
      }
      .lyrics-box {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

<div class="admin-controls">
  <button onclick="toggleFullscreen()">üñ•Ô∏è Fullscreen</button>
  <button onclick="clearQueue()">üóëÔ∏è Clear Queue</button>
</div>

<div class="tv-container">
  <div class="header">üé§ VIDEOKE SYSTEM</div>

  <!-- Queue Bar - Outside Player Section -->
  <div class="queue-box">
    <div>üìú NEXT SONGS</div>
    <div id="queueList"></div>
  </div>

  <div class="player-section">
    <iframe id="player" allowfullscreen></iframe>
    <!-- Countdown Overlay -->
    <div id="countdownOverlay" class="countdown-overlay">
      <div id="countdownText" class="countdown-text">3</div>
    </div>
  </div>

  <div class="bottom-section">
    <div class="qr-section">
      <div style="font-size: 14px; font-weight: bold;">üì± Scan to Control</div>
      <img id="qr" alt="QR Code">
    </div>
  </div>
</div>

<!-- Score Overlay - Shows when song ends -->
<div id="scoreOverlay" class="score-overlay">
  <div class="score-content">
    <div class="score-title">üé§ SCORE</div>
    <div class="score-value" id="scoreOverlayValue">--</div>
    <div class="singer-name" id="scoreOverlaySinger">Unknown Singer</div>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Project Scripts -->
<script src="js/firebase.js"></script>
<script src="js/lyrics.js"></script>

<script>
console.log("üìù Initializing variables...");
let iframe = document.getElementById("player");
const queueList = document.getElementById("queueList");
const scoreDisplay = document.getElementById("score");
const singerDisplay = document.getElementById("singer");
const qrCode = document.getElementById("qr");

console.log("‚úÖ Variables initialized:", {
  iframe: !!iframe,
  queueList: !!queueList,
  qrCode: !!qrCode
});

let currentLyricIndex = 0;
let playStartTime = 0;
let player = null;
let currentSongKey = null;
let songStats = {
  startTime: null,
  totalDuration: 0,
  pauseCount: 0,
  totalPausedTime: 0,
  wasSkipped: false,
  completionPercentage: 100
};

// YouTube IFrame API - required for player state detection
function loadYouTubeAPI() {
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);
}

// Called by YouTube API when player is ready
function onYouTubeIframeAPIReady() {
  console.log("YouTube API Ready");
}

// Listen to player state changes
function handlePlayerStateChange(newState) {
  console.log("Player state:", newState);
  // 0 = ENDED, 1 = PLAYING, 2 = PAUSED, 3 = BUFFERING, -1 = UNSTARTED
  
  if (newState === 0) {
    console.log("‚èπÔ∏è Song ended! Removing from queue...");
    // Song ended - remove current song and load next
    if (currentSongKey) {
      db.ref("queue/" + currentSongKey).remove(() => {
        console.log("‚úÖ Song removed from queue");
        // Wait a moment then load next song
        setTimeout(() => {
          loadCurrentSong();
        }, 500);
      });
    } else {
      // Just load next song if no key stored
      loadCurrentSong();
    }
  }
}

// Generate QR Code (point to controller)
function generateQR() {
  const controllerUrl = window.location.origin + "/controller-simple.html";
  qrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(controllerUrl)}`;
}

// Load video from current song
function loadCurrentSong() {
  if (!window.db) {
    console.error("‚ùå Firebase not available!");
    return;
  }

  console.log("üì° Setting up real-time listener for currentSong");
  
  // Use .on() listener for real-time updates
  db.ref("currentSong").on("value", snap => {
    console.log("üîî Listener triggered! Data changed");
    
    const song = snap.val();
    
    if (!song || !song.videoId) {
      console.log("‚è∏Ô∏è No current song data");
      return;
    }

    console.log("üé¨ Current song detected:", song.title, "ID:", song.videoId, "Timestamp:", song.timestamp);

    // Get the current player container
    const playerElement = document.getElementById("player");
    const playerContainer = playerElement?.parentElement;
    
    if (!playerContainer) {
      console.error("‚ùå Player container not found!");
      return;
    }

    console.log("‚ñ∂Ô∏è Loading new video:", song.videoId);

    // Show countdown overlay
    const countdownOverlay = document.getElementById("countdownOverlay");
    const countdownText = document.getElementById("countdownText");
    
    // Check if countdown should be skipped (for PLAY button immediate playback)
    const shouldSkipCountdown = song.skipCountdown === true;
    
    if (countdownOverlay && !shouldSkipCountdown) {
      countdownOverlay.classList.add("show");
    }

    // Start countdown: 3, 2, 1 (or skip if flag is set)
    let count = 3;
    const countdownInterval = setInterval(() => {
      if (countdownText) {
        countdownText.textContent = count;
      }
      count--;
      
      if (count < 0) {
        clearInterval(countdownInterval);
        // Hide countdown and load video
        if (countdownOverlay) {
          countdownOverlay.classList.remove("show");
        }

        // Create new iframe to force reload with autoplay
        const newIframe = document.createElement("iframe");
        newIframe.id = "player";
        newIframe.allowFullscreen = true;
        newIframe.style.width = "100%";
        newIframe.style.flex = "1";
        newIframe.style.border = "none";
        newIframe.style.display = "block";
        newIframe.style.position = "relative";
        
        // Build YouTube embed URL - no autoplay yet, we'll control via API
        const youtubeUrl = `https://www.youtube.com/embed/${song.videoId}?controls=0&enablejsapi=1&modestbranding=1`;
        newIframe.src = youtubeUrl;
        
        console.log("üîó Loading YouTube URL:", youtubeUrl);
        
        // Clear and add new iframe (but keep countdown overlay inside)
        const countdownDiv = playerContainer.querySelector("#countdownOverlay");
        playerContainer.innerHTML = "";
        playerContainer.appendChild(newIframe);
        if (countdownDiv) {
          playerContainer.appendChild(countdownDiv);
        }
        
        // Update global reference
        iframe = newIframe;
        console.log("‚úÖ Video iframe loaded and updated");
        
        // Play video with volume via YouTube Player API after countdown
        setTimeout(() => {
          try {
            // Destroy old player if exists
            if (window.player && typeof window.player.destroy === 'function') {
              window.player.destroy();
            }
            
            if (window.YT && window.YT.Player) {
              window.player = new YT.Player('player', {
                events: {
                  'onReady': (event) => {
                    console.log("üé¨ YouTube Player Ready - Starting playback");
                    // Set volume to 100 FIRST (before playing)
                    event.target.setVolume(100);
                    // Then play with sound
                    event.target.playVideo();
                    console.log("‚ñ∂Ô∏è Video playing with full volume");
                  },
                  'onError': (event) => {
                    console.error("‚ùå YouTube Player Error:", event.data);
                  }
                }
              });
            }
          } catch (e) {
            console.log("‚ö†Ô∏è Could not initialize player:", e.message);
          }
        }, 100);
        
        // Update singer display
        if (singerDisplay) {
          singerDisplay.innerText = song.userName || "Unknown Singer";
        }
      }
    }, shouldSkipCountdown ? 1 : 1000);
  }, error => {
    console.error("‚ùå Firebase listener error:", error);
  });
  
  console.log("‚úÖ Listener setup complete");
}

// Display lyrics with timing
function playLyrics(videoId) {
  // Lyrics display removed - focusing on queue display
  return;
}

// Listen for score updates
function loadScore() {
  db.ref("currentScore").on("value", snap => {
    const score = snap.val();
    if (score && scoreDisplay && singerDisplay) {
      scoreDisplay.innerText = score.points || "--";
      singerDisplay.innerText = score.name || "Unknown";
    }
  });
}

// Display queue
function displayQueue() {
  // Make sure Firebase is ready
  if (!db) {
    console.error("‚ùå Firebase not ready yet");
    setTimeout(displayQueue, 100);
    return;
  }
  
  if (!queueList) {
    console.error("‚ùå queueList element not found!");
    return;
  }
  
  console.log("üîÑ Starting queue listener...");
  
  db.ref("queue").on("value", snap => {
    const queue = snap.val();
    console.log("üìú Queue data:", queue);
    queueList.innerHTML = "";

    if (!queue) {
      console.log("‚ùå Queue is empty");
      queueList.innerHTML = '<div class="queue-item">No songs waiting...</div>';
      return;
    }

    let count = 0;
    Object.entries(queue).forEach(([key, song]) => {
      // Only show songs that have a title
      if (song && song.title && count < 4) {
        console.log(`‚úÖ Adding song ${count + 1}:`, song.title);
        const item = document.createElement("div");
        item.className = "queue-item";
        item.innerHTML = `<strong>${count + 1}. ${song.title}</strong>`;
        queueList.appendChild(item);
        count++;
      }
    });
    console.log(`üìä Total songs displayed: ${count}`);
  }, error => {
    console.error("‚ùå Queue read error:", error);
  });
}

// Auto-play next song from queue
function autoPlayNext() {
  let songTimeout = null;
  let lastSongVideoId = null;
  let pauseStartTime = null;
  
  // Listen to current song changes
  db.ref("currentSong").on("value", snap => {
    const currentSong = snap.val();
    
    // Clear any existing timeout
    if (songTimeout) clearTimeout(songTimeout);
    
    if (currentSong && currentSong.videoId) {
      // Song is playing - reset stats and hide score overlay
      document.getElementById("scoreOverlay").classList.remove("show");
      if (singerDisplay) {
        singerDisplay.innerText = currentSong.userName || "Unknown";
      }
      console.log("üì∫ Now playing:", currentSong.title);
      lastSongVideoId = currentSong.videoId;
      
      // Load the video immediately with autoplay
      loadCurrentSong();
      // Reset song statistics
      songStats = {
        startTime: Date.now(),
        totalDuration: 300, // Assume 5 min song (300 sec)
        pauseCount: 0,
        totalPausedTime: 0,
        wasSkipped: false,
        completionPercentage: 100
      };
      pauseStartTime = null;
      
      // Listen to play/pause states during song
      let playerStateListener = setInterval(() => {
        // Track pauses if we can
        songStats.pauseCount = (songStats.pauseCount || 0);
      }, 1000);
      
      // Set up a timeout to detect song end (5 min typical song length)
      songTimeout = setTimeout(() => {
        clearInterval(playerStateListener);
        console.log("‚èπÔ∏è Song timeout - showing score...");
        const score = calculateScore(songStats);
        showScoreOverlay("Singer", score);
      }, 310000); // 5 min 10 sec
    } else {
      // Song ended (currentSong was cleared)
      console.log("üéµ Current song cleared - song finished playing");
      // Mark as skipped if time is too early
      const elapsedTime = Date.now() - songStats.startTime;
      if (elapsedTime < 30000) { // Skipped in less than 30 seconds
        songStats.wasSkipped = true;
        songStats.completionPercentage = Math.floor((elapsedTime / 300000) * 100);
      }
      
      const score = calculateScore(songStats);
      showScoreOverlay("Singer", score);
      
      // Load next from queue after a delay
      setTimeout(() => {
        db.ref("queue").limitToFirst(1).once("value", queueSnap => {
          const queueData = queueSnap.val();
          if (queueData) {
            const [key, song] = Object.entries(queueData)[0];
            if (song && song.videoId) {
              console.log("‚ñ∂Ô∏è Setting next song:", song.title);
              db.ref("currentSong").set(song);
              currentSongKey = key;
            }
          }
        });
      }, 3000); // Wait 3 seconds (score display time) before loading next
    }
  });
}

// Calculate realistic score based on performance
function calculateScore(stats) {
  let baseScore = 100;
  
  // Penalty for skipping early (less than 1 minute played)
  if (stats.wasSkipped && stats.completionPercentage < 20) {
    baseScore = Math.floor(Math.random() * 20) + 30; // 30-50 points
    console.log("‚è© Song skipped early - Score:", baseScore);
    return baseScore;
  }
  
  // Penalty for partial completion (20-80%)
  if (stats.completionPercentage < 80) {
    const incompletePenalty = Math.floor((80 - stats.completionPercentage) * 0.3);
    baseScore -= incompletePenalty;
  }
  
  // Penalty for pauses (more pauses = lower score)
  const pausePenalty = Math.min(stats.pauseCount * 5, 15);
  baseScore -= pausePenalty;
  
  // Add some variance for more natural results
  const variance = Math.floor(Math.random() * 10) - 5; // -5 to +5
  baseScore += variance;
  
  // Clamp score between 60-100
  baseScore = Math.max(60, Math.min(100, baseScore));
  
  console.log(`üìä Score Calculation: Base=${baseScore}, Completion=${stats.completionPercentage}%, Pauses=${stats.pauseCount}`);
  return baseScore;
}

// Show score overlay when song ends
function showScoreOverlay(singerName, score = null) {
  const overlay = document.getElementById("scoreOverlay");
  const scoreValue = document.getElementById("scoreOverlayValue");
  
  if (!overlay) {
    console.error("Score overlay element not found!");
    return;
  }
  
  // Use provided score or generate random if full song completed
  let displayScore = score;
  if (!displayScore) {
    displayScore = Math.floor(Math.random() * 16) + 85; // 85-100 for full completion
  }
  
  scoreValue.innerText = displayScore.toString();
  
  console.log("‚úÖ Showing score overlay with score:", displayScore);
  overlay.classList.add("show");
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    overlay.classList.remove("show");
  }, 3000);
}

// Fullscreen
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

// Clear queue (admin only)
function clearQueue() {
  const pin = prompt("üîê Admin PIN:");
  if (pin === "1234") {
    db.ref("queue").remove();
    alert("‚úÖ Queue cleared");
  } else {
    alert("‚ùå Incorrect PIN");
  }
}

// Initialize
window.addEventListener("load", () => {
  // Set up listener with Firebase ready check
  waitForFirebase(() => {
    console.log("üöÄ Initializing TV screen...");
    loadCurrentSong();
    generateQR();
    displayQueue();
    loadScore();
    autoPlayNext();
  });
});
</script>

</body>
</html>
